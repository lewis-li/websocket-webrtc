<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        header.main {
            background-color: #eee;
        }

        header .notify {
            background-color: blue;
            color: #eee;
        }

        #login .btn {
            display: inline-block;
            margin: 1vh 1vw;
        }
    </style>
</head>

<body>
    <div id="app">

        <header class="main">
            <h1>
                {{ app_name }}
            </h1>

            <div class="notify"> --&gt; {{notify}}</div>
        </header>

        <!-- login -->
        <div id="login" v-if="user.status === 0">
            <div>
                输入用户:<input type="text" name="username" v-model="user.username">
            </div>
            <div>
                <button v-on:click="login">确定</button>
            </div>
        </div>

        <!-- /login -->

        <!-- join_room -->
        <div id="join_room" v-if="user.status === 1 && room.status === 0">
            <div>
                加入房间:<input type="text" name="roomname" v-model="room.roomname">
            </div>
            <div>
                <button v-on:click="join_room">确定</button>
            </div>
        </div>
        <!-- /join_room -->

        <!-- room_view -->
        <div id="room_view" v-if="room.status === 1">
            <div class="controllers">
                发送消息:<input type="text">
                <button>发送</button>
                <button>订阅/取消订阅</button>
                <button>发布/取消发布</button>
                
            </div>
        </div>
        <!-- /room_view-->
    </div>
</body>
<script src="./js/main.js"></script>
<script>
    var app = new Vue({
        // 选项
        el: '#app',
        data: {
            app_name: '多人音视频',
            notify: '',
            room: {
                roomname: null,
                status: 0,
            },
            user: {
                username: null,
                status: 0,
            }
        },
        methods: {
            login: async function () {
                const username = this.user.username
                const response = await fetch(`${auth_server_host}?user_id=${username}`)
                // todo 异常处理
                const data = await response.json()
                const token = data.token
                this.notify = '获得TOKEN成功'

                // get token
                try {
                    await webSocketRpcClient.connection(`${sign_server_host}?token=${token}`)
                } catch (error) {
                    this.notify = '登录失败'
                    return
                }

                this.user.status = 1
                this.notify = '登录成功'
                console.log(this.user.username + ' login success')
            },

            join_room: async function () {
                console.log('join room:' + this.room.roomname)

                const username = this.room.roomname
                const roomname = this.user.username

                if (username == '' || roomname == '') {
                    alert('用户或者房间名为空')
                    return
                }

                console.log(`${username} join room:`)

                const { roomToken } = await webSocketRpcClient.send({
                    method: 'getRoomToken',
                    params: {
                        username,
                        roomname
                    }
                }, true)

                console.log(roomToken)

                const myRoom = await joinRoomWithToken('track', roomToken)
                console.log('room', myRoom)
                console.log('join room success')
                this.notify = '进入房间:' + this.room.roomname
                this.room.status = 1

                // try {
                //     await publish(myRoom)
                // } catch (error) {
                //     console.log(error)
                //     alert(error)
                // }
            },
        }
    })

    window.onload = function () {
        if (typeof vConsole !== undefined) {
            const vconsole = new vConsole()
        }
    }
</script>

</html>