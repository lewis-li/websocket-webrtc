<html>

    <head>
        <!--script src="adapter.js"></script-->
        <script src="vconsole.min.js"></script>

        <script>
            let vConsole = new VConsole()
            window.onload = function () {

                // 老的浏览器可能根本没有实现 mediaDevices，所以我们可以先设置一个空的对象
                if (navigator.mediaDevices === undefined) {
                    navigator.mediaDevices = {}
                }

                // 一些浏览器部分支持 mediaDevices。我们不能直接给对象设置 getUserMedia
                // 因为这样可能会覆盖已有的属性。这里我们只会在没有getUserMedia属性的时候添加它。
                if (navigator.mediaDevices.getUserMedia === undefined) {
                    if (navigator.getUserMedia) {
                        navigator.mediaDevices.getUserMedia = navigator.getUserMedia
                    } else {
                        navigator.mediaDevices.getUserMedia = function (constraints) {

                            // 首先，如果有getUserMedia的话，就获得它
                            var getUserMedia = navigator.webkitGetUserMedia || navigator.mozGetUserMedia

                            // 一些浏览器根本没实现它 - 那么就返回一个error到promise的reject来保持一个统一的接口
                            if (!getUserMedia) {
                                return Promise.reject(new Error('getUserMedia is not implemented in this browser'))
                            }

                            // 否则，为老的navigator.getUserMedia方法包裹一个Promise
                            return new Promise(function (resolve, reject) {
                                getUserMedia.call(navigator, constraints, resolve, reject)
                            })
                        }
                    }
                }

                let video = document.getElementById('video')
                let snap = document.getElementById('snap')

                var context = canvas.getContext('2d');

                // Trigger photo take
                snap.addEventListener("click", function () {
                    context.drawImage(video, 0, 0, 640, 480)
                })

                let constraints = {
                    audio: true,
                    video: {
                        width: 1280,
                        height: 720
                    }
                }

                navigator
                    .mediaDevices
                    .getUserMedia(constraints)
                    .then(function (stream) {
                        console.log(stream)
                        video.srcObject = stream
                        video.play()
                    })
                    .catch(function (e) {
                        console.log(e.name + ": " + e.message)
                    })
                }
        </script>
    </head>

    <body>
        <video id="video" width="640" height="480" autoplay></video>
        <button id="snap" class="sexyButton">Snap Photo</button>
        <canvas id="canvas" width="640" height="480"></canvas>
    </body>

</html>